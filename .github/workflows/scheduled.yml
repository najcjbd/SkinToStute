name: Scheduled Tests

on:
  schedule:
    # 每天凌晨2点运行（UTC时间）
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  full-test-suite:
    name: Full Test Suite
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Clean and build
        run: ./gradlew clean build

      - name: Run all tests
        run: ./gradlew testDebugUnitTest connectedAndroidTest

      - name: Run all code quality checks
        run: ./gradlew runLintChecks

      - name: Generate test coverage
        run: ./gradlew jacocoTestReport

      - name: Upload all reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: scheduled-reports
          path: |
            app/build/reports/tests/
            app/build/reports/androidTests/
            app/build/reports/lint-*
            build/reports/detekt/
            app/build/reports/jacoco/

      - name: Check coverage threshold
        run: |
          COVERAGE=$(grep -oP 'Total.*?(\d+)%' app/build/reports/jacoco/jacocoTestReport/html/index.html | head -1 | grep -oP '\d+')
          MIN_COVERAGE=80
          
          echo "Current coverage: ${COVERAGE}%"
          echo "Minimum required: ${MIN_COVERAGE}%"
          
          if [ "$COVERAGE" -lt "$MIN_COVERAGE" ]; then
            echo "❌ Coverage below threshold"
            exit 1
          else
            echo "✅ Coverage meets threshold"
          fi

  performance-test:
    name: Performance Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Run performance tests
        run: ./gradlew test --tests "*Performance*"

      - name: Measure build time
        run: |
          START_TIME=$(date +%s)
          ./gradlew clean assembleDebug
          END_TIME=$(date +%s)
          BUILD_TIME=$((END_TIME - START_TIME))
          
          echo "Build time: ${BUILD_TIME}s"
          
          if [ $BUILD_TIME -gt 300 ]; then
            echo "⚠️ Build time exceeds 5 minutes"
          else
            echo "✅ Build time is acceptable"
          fi

  compatibility-test:
    name: Compatibility Tests
    runs-on: ${{ matrix.os }}
    
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      - name: Grant execute permission for gradlew (Unix)
        if: runner.os != 'Windows'
        run: chmod +x gradlew

      - name: Build on ${{ matrix.os }}
        run: ./gradlew build

      - name: Run tests on ${{ matrix.os }}
        run: ./gradlew test